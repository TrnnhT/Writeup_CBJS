FROM ubuntu/mysql:latest

# Update package sources list and install required packages
RUN apt update -y && apt install apache2 php libapache2-mod-php php-mysql -y

# Add user www-data to the mysql group
RUN usermod -a -G mysql www-data

# Copy SQL script to the Docker entrypoint directory for initialization
COPY ./database /docker-entrypoint-initdb.d

# Copy challenge files to the working directory
WORKDIR /var/www/html/
COPY ./html/ .
COPY flag /flag_a7bd2

# Set up permissions for the owner
RUN chown -R root:www-data .
RUN find . -type f -exec chmod 640 {} \;
RUN find . -type d -exec chmod 750 {} \;
RUN chmod 777 .

# Add sticky bit to prevent deletion of files
RUN chmod +t -R .

# Start Apache and MySQL services with custom command
CMD ["bash", "-c", "/usr/sbin/apache2ctl start && /usr/local/bin/docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password --secure-file-priv=''"]